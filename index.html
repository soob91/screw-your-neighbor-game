<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta viewport="width=device-width, initial-scale=1.0">
    <title>Screw Your Neighbor - Personal Table</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 10px 0;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .game-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            opacity: 0.9;
            flex-wrap: wrap;
        }

        /* Personal Table Layout */
        .personal-table {
            margin-bottom: 15px;
        }

        .focus-grid {
            display: grid;
            grid-template-columns: 1fr 0.8fr 1fr;
            grid-template-rows: auto auto;
            gap: 8px;
            margin-bottom: 15px;
        }

        .focus-slot {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 8px;
            min-height: 140px;
            position: relative;
            transition: all 0.3s ease;
        }

        .focus-slot.current-turn {
            border-color: #00FF00;
            box-shadow: 0 0 15px rgba(0,255,0,0.3);
            grid-column: 2;
            grid-row: 1;
        }

        .focus-slot.left-neighbor {
            border-color: #FF6B35;
            grid-column: 1;
            grid-row: 1;
        }

        .focus-slot.right-neighbor {
            border-color: #FF6B35;
            grid-column: 3;
            grid-row: 1;
        }

        .focus-slot.custom {
            border-color: #FFD700;
            grid-row: 2;
        }

        .focus-slot.custom:first-of-type {
            grid-column: 1;
        }

        .focus-slot.custom:last-of-type {
            grid-column: 3;
        }

        .focus-slot.empty {
            border: 2px dashed rgba(255,255,255,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: rgba(255,255,255,0.6);
            font-size: 0.8rem;
        }

        .focus-slot.empty .add-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .video-container {
            width: 100%;
            height: 60px;
            background: #333;
            border-radius: 8px;
            margin-bottom: 5px;
            overflow: hidden;
            position: relative;
        }

        .video-element {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }

        .player-name {
            font-weight: bold;
        }

        .player-lives {
            background: rgba(255,0,0,0.8);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .card-display {
            width: 100%;
            height: 50px;
            background: #fff;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-weight: bold;
            margin-bottom: 5px;
            border: 1px solid #ddd;
        }

        .card-display.face-down {
            background: #1e3c72;
            color: white;
        }

        .card-display.red {
            color: #d73027;
        }

        .card-display.black {
            color: #333;
        }

        .action-button {
            width: 100%;
            padding: 4px 8px;
            background: #00a8ff;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 0.7rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .action-button:hover {
            background: #0097e6;
        }

        .action-button:disabled {
            background: rgba(255,255,255,0.3);
            cursor: not-allowed;
        }

        .remove-button {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: rgba(255,0,0,0.8);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 0.7rem;
            cursor: pointer;
            display: none;
        }

        .focus-slot.custom .remove-button {
            display: block;
        }

        /* Available Players Bar */
        .available-players {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .available-title {
            font-size: 0.9rem;
            margin-bottom: 8px;
            text-align: center;
            opacity: 0.8;
        }

        .players-scroll {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding: 5px 0;
        }

        .available-player {
            min-width: 80px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            position: relative;
        }

        .available-player:hover {
            background: rgba(255,255,255,0.2);
        }

        .available-player.focused {
            border-color: #00FF00;
            background: rgba(0,255,0,0.1);
        }

        .available-player .check-mark {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #00FF00;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .available-player .player-name {
            font-size: 0.7rem;
            margin-bottom: 3px;
        }

        .available-player .mini-card {
            width: 100%;
            height: 25px;
            background: #fff;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-size: 0.6rem;
            font-weight: bold;
        }

        .available-player .mini-card.face-down {
            background: #1e3c72;
            color: white;
        }

        /* Game Controls */
        .game-controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .control-button {
            padding: 12px 8px;
            background: #27ae60;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .control-button:disabled {
            background: rgba(255,255,255,0.3);
            cursor: not-allowed;
            transform: none;
        }

        .control-button.danger {
            background: #e74c3c;
        }

        .control-button.warning {
            background: #f39c12;
        }

        /* Chat and Game Log */
        .bottom-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .chat-section, .game-log {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
            height: 150px;
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 0.9rem;
            margin-bottom: 8px;
            text-align: center;
            opacity: 0.8;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 5px;
            background: rgba(0,0,0,0.2);
            font-size: 0.7rem;
            margin-bottom: 8px;
        }

        .chat-input {
            display: flex;
            gap: 5px;
        }

        .chat-input input {
            flex: 1;
            padding: 6px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.8rem;
        }

        .chat-input button {
            padding: 6px 12px;
            background: #3498db;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* Menu Screens */
        .menu-screen {
            text-align: center;
            padding: 20px;
            max-width: 400px;
            margin: 0 auto;
        }

        .menu-button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: #3498db;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .input-group {
            margin: 15px 0;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
        }

        /* Loading and Status */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.1rem;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .focus-grid {
                grid-template-columns: 1fr 0.7fr 1fr;
                gap: 6px;
            }
            
            .focus-slot {
                min-height: 120px;
                padding: 6px;
            }
            
            .video-container {
                height: 50px;
            }
            
            .game-controls {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .bottom-section {
                grid-template-columns: 1fr;
            }
        }

        /* Hidden elements */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Main Menu -->
    <div id="main-menu" class="menu-screen">
        <h1>üé¥ Screw Your Neighbor</h1>
        <p>Personal Table Experience</p>
        
        <button class="menu-button" onclick="showQuickMatch()">‚ö° Quick Match</button>
        <button class="menu-button" onclick="showCreateGame()">üéÆ Create Private Game</button>
        <button class="menu-button" onclick="showJoinGame()">üéØ Join Game</button>
        
        <div class="input-group">
            <label for="playerName">Your Name:</label>
            <input type="text" id="playerName" placeholder="Enter your name" value="Player">
        </div>
    </div>

    <!-- Quick Match Screen -->
    <div id="quick-match" class="menu-screen hidden">
        <h2>‚ö° Quick Match</h2>
        <p>Finding available games...</p>
        <div class="loading">
            <div class="spinner"></div>
            <span>Searching for players...</span>
        </div>
        <button class="menu-button" onclick="showMainMenu()">‚Üê Back</button>
    </div>

    <!-- Create Game Screen -->
    <div id="create-game" class="menu-screen hidden">
        <h2>üéÆ Create Private Game</h2>
        
        <div class="input-group">
            <label for="startingLives">Starting Lives:</label>
            <select id="startingLives">
                <option value="3">3 Lives</option>
                <option value="5">5 Lives</option>
                <option value="7">7 Lives</option>
            </select>
        </div>
        
        <div class="input-group">
            <label for="deckCount">Number of Decks:</label>
            <select id="deckCount">
                <option value="1">1 Deck</option>
                <option value="2">2 Decks</option>
            </select>
        </div>
        
        <button class="menu-button" onclick="createPrivateGame()">Create Game</button>
        <button class="menu-button" onclick="showMainMenu()">‚Üê Back</button>
    </div>

    <!-- Join Game Screen -->
    <div id="join-game" class="menu-screen hidden">
        <h2>üéØ Join Game</h2>
        
        <div class="input-group">
            <label for="gameCode">Game Code:</label>
            <input type="text" id="gameCode" placeholder="Enter game code" style="text-transform: uppercase;">
        </div>
        
        <button class="menu-button" onclick="joinGame()">Join Game</button>
        <button class="menu-button" onclick="showMainMenu()">‚Üê Back</button>
    </div>

    <!-- Game Content -->
    <div id="gameContent" class="container hidden">
        <!-- Header -->
        <div class="header">
            <h1>üé¥ Screw Your Neighbor</h1>
            <div class="game-status">
                <span id="gameCode">Game: <strong>LOADING</strong></span>
                <span id="playerCount">Players: <strong>0/0</strong></span>
                <span id="connectionStatus">üî¥ Connecting...</span>
            </div>
        </div>

        <!-- Personal Table -->
        <div class="personal-table">
            <div class="focus-grid" id="focusGrid">
                <!-- Focus slots will be populated by JavaScript -->
            </div>
        </div>

        <!-- Available Players Bar -->
        <div class="available-players">
            <div class="available-title">Available Players - Tap to Focus</div>
            <div class="players-scroll" id="playersScroll">
                <!-- Available players will be populated by JavaScript -->
            </div>
        </div>

        <!-- Game Controls -->
        <div class="game-controls">
            <button class="control-button" id="flipCardBtn" onclick="flipCard()" disabled>
                üé¥ Flip Card
            </button>
            <button class="control-button" id="keepCardBtn" onclick="keepCard()" disabled>
                ‚úã Keep Card
            </button>
            <button class="control-button warning" id="endRoundBtn" onclick="endRound()" disabled>
                ‚è∞ End Round
            </button>
            <button class="control-button danger" onclick="leaveGame()">
                üö™ Leave
            </button>
        </div>

        <!-- Bottom Section -->
        <div class="bottom-section">
            <div class="chat-section">
                <div class="section-title">üí¨ Chat</div>
                <div class="messages" id="chatMessages"></div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Type a message..." maxlength="100">
                    <button onclick="sendChatMessage()">Send</button>
                </div>
            </div>
            <div class="game-log">
                <div class="section-title">üìã Game Log</div>
                <div class="messages" id="gameMessages"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.19.1.js"></script>
    
    <script>
        // Global variables
        let socket;
        let currentGame = null;
        let playerId = null;
        let playerName = '';
        
        // Personal Table state
        let focusedPlayers = {
            leftNeighbor: null,
            currentTurn: null,
            rightNeighbor: null,
            custom1: null,
            custom2: null
        };
        
        // Video state
        let isVideoJoined = false;
        let agoraClient = null;
        let localVideoTrack = null;
        let localAudioTrack = null;
        let remoteUsers = {};

        // Utility functions
        function log(message) {
            console.log(`[${new Date().toLocaleTimeString()}] ${message}`);
            addGameMessage(message);
        }

        function addGameMessage(message) {
            const gameMessages = document.getElementById('gameMessages');
            if (gameMessages) {
                const messageDiv = document.createElement('div');
                messageDiv.textContent = message;
                gameMessages.appendChild(messageDiv);
                gameMessages.scrollTop = gameMessages.scrollHeight;
            }
        }

        function addChatMessage(playerName, message) {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                const messageDiv = document.createElement('div');
                messageDiv.innerHTML = `<strong>${playerName}:</strong> ${message}`;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Menu navigation
        function showMainMenu() {
            document.querySelectorAll('.menu-screen, #gameContent').forEach(el => el.classList.add('hidden'));
            document.getElementById('main-menu').classList.remove('hidden');
        }

        function showQuickMatch() {
            document.querySelectorAll('.menu-screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('quick-match').classList.remove('hidden');
            // Start quick match logic
            connectToServer();
            setTimeout(() => {
                createPublicGame();
            }, 1000);
        }

        function showCreateGame() {
            document.querySelectorAll('.menu-screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('create-game').classList.remove('hidden');
        }

        function showJoinGame() {
            document.querySelectorAll('.menu-screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('join-game').classList.remove('hidden');
        }

        function showGameContent() {
            document.querySelectorAll('.menu-screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('gameContent').classList.remove('hidden');
        }

        // Server connection
        function connectToServer() {
            log('üîÑ Attempting to connect to server...');
            socket = io();
            
            socket.on('connect', () => {
                log('‚úÖ Connected to server! Transport: ' + socket.io.engine.transport.name);
                document.getElementById('connectionStatus').innerHTML = 'üü¢ Connected';
                
                playerName = document.getElementById('playerName').value || 'Player';
                playerId = socket.id;
            });

            socket.on('disconnect', () => {
                log('‚ùå Disconnected from server');
                document.getElementById('connectionStatus').innerHTML = 'üî¥ Disconnected';
            });

            setupSocketEvents();
        }

        // Socket event handlers
        function setupSocketEvents() {
            socket.on('public-game-created', function(data) {
                log('üéÆ Public game created! Waiting for players...');
                currentGame = data.game;
                showGameContent();
                updateGameDisplay();
                updatePersonalTable();
            });

            socket.on('game-created', function(data) {
                log('üéÆ Private game created!');
                currentGame = data.game;
                showGameContent();
                updateGameDisplay();
                updatePersonalTable();
            });

            socket.on('game-joined', function(data) {
                log('üéÆ Successfully joined game!');
                if (data.friendCode) {
                    log(`üì± Your friend code: ${data.friendCode}`);
                }
                currentGame = data.game;
                showGameContent();
                updateGameDisplay();
                updatePersonalTable();
            });

            socket.on('player-joined', function(data) {
                log(`üëã Player joined: ${data.playerName}`);
                currentGame = data.game;
                updateGameDisplay();
                updatePersonalTable();
            });

            socket.on('game-started', function(data) {
                log('üéÆ Game started!');
                currentGame = data.game;
                updateGameDisplay();
                updatePersonalTable();
                
                // Start video call
                setTimeout(() => {
                    initializeVideoCall();
                }, 1000);
            });

            socket.on('trade-completed', function(data) {
                log(`üîÑ ${data.player1} and ${data.player2} traded cards`);
                currentGame = data.game;
                updateGameDisplay();
                updatePersonalTable();
            });

            socket.on('turn-skipped', function(data) {
                log(`‚è≠Ô∏è ${data.playerName} kept their card`);
                currentGame = data.game;
                updateGameDisplay();
                updatePersonalTable();
            });

            socket.on('card-flipped', function(data) {
                log(`üé¥ ${data.playerName} flipped their card`);
                currentGame = data.game;
                updateGameDisplay();
                updatePersonalTable();
            });

            socket.on('dealer-traded-deck', function(data) {
                log('üé¥ Dealer traded with deck');
                currentGame = data.game;
                updateGameDisplay();
                updatePersonalTable();
            });

            socket.on('dealer-skipped-trade', function(data) {
                log('üé¥ Dealer kept their card');
                currentGame = data.game;
                updateGameDisplay();
                updatePersonalTable();
            });

            socket.on('round-ended', function(data) {
                log(`üèÅ Round ${data.round} ended. Losers: ${data.losers.join(', ')}`);
                currentGame = data.game;
                updateGameDisplay();
                updatePersonalTable();
            });

            socket.on('game-finished', function(data) {
                log(`üéâ Game finished! Winner: ${data.winner}`);
                currentGame = data.game;
                updateGameDisplay();
                updatePersonalTable();
            });

            socket.on('chat-message', function(data) {
                addChatMessage(data.playerName, data.message);
            });

            socket.on('error', function(data) {
                log(`‚ùå Error: ${data.message}`);
                alert(data.message);
            });
        }

        // Game creation and joining
        function createPublicGame() {
            if (!socket) {
                connectToServer();
                setTimeout(createPublicGame, 1000);
                return;
            }

            const settings = {
                startingLives: 3,
                deckCount: 1,
                tournamentMode: 'single',
                cardStyle: 'classic'
            };

            socket.emit('create-public-game', {
                playerName: playerName,
                settings: settings
            });
        }

        function createPrivateGame() {
            if (!socket) {
                connectToServer();
                setTimeout(createPrivateGame, 1000);
                return;
            }

            const settings = {
                startingLives: parseInt(document.getElementById('startingLives').value),
                deckCount: parseInt(document.getElementById('deckCount').value),
                tournamentMode: 'single',
                cardStyle: 'classic'
            };

            socket.emit('create-private-game', {
                playerName: playerName,
                settings: settings
            });
        }

        function joinGame() {
            const gameCode = document.getElementById('gameCode').value.toUpperCase();
            if (!gameCode) {
                alert('Please enter a game code');
                return;
            }

            if (!socket) {
                connectToServer();
                setTimeout(() => joinGame(), 1000);
                return;
            }

            socket.emit('join-game', {
                gameCode: gameCode,
                playerName: playerName
            });
        }

        // Game display updates
        function updateGameDisplay() {
            if (!currentGame) return;

            // Update header
            document.getElementById('gameCode').innerHTML = `Game: <strong>${currentGame.gameCode || 'UNKNOWN'}</strong>`;
            document.getElementById('playerCount').innerHTML = `Players: <strong>${currentGame.players.length}/${currentGame.maxPlayers || 8}</strong>`;

            // Update button states
            updateButtonStates();
        }

        function updateButtonStates() {
            if (!currentGame) return;

            const myPlayer = currentGame.players.find(p => p.id === playerId);
            const isMyTurn = currentGame.currentPlayerIndex !== undefined && 
                           currentGame.players[currentGame.currentPlayerIndex]?.id === playerId;
            const gameStarted = currentGame.status === 'playing';

            document.getElementById('flipCardBtn').disabled = !isMyTurn || !gameStarted;
            document.getElementById('keepCardBtn').disabled = !isMyTurn || !gameStarted;
            document.getElementById('endRoundBtn').disabled = !isMyTurn || !gameStarted;
        }

        // Personal Table management
        function updatePersonalTable() {
            if (!currentGame || !currentGame.players) return;

            // Calculate player positions and roles
            const myPlayerIndex = currentGame.players.findIndex(p => p.id === playerId);
            if (myPlayerIndex === -1) return;

            const playerCount = currentGame.players.length;
            const leftNeighborIndex = (myPlayerIndex - 1 + playerCount) % playerCount;
            const rightNeighborIndex = (myPlayerIndex + 1) % playerCount;
            const currentTurnIndex = currentGame.currentPlayerIndex || 0;

            // Auto-assign core players
            focusedPlayers.leftNeighbor = currentGame.players[leftNeighborIndex];
            focusedPlayers.rightNeighbor = currentGame.players[rightNeighborIndex];
            focusedPlayers.currentTurn = currentGame.players[currentTurnIndex];

            // Auto-assign dealer if not already in focus
            const dealer = currentGame.players.find(p => p.isDealer);
            if (dealer && !isPlayerInFocus(dealer.id)) {
                if (!focusedPlayers.custom1) {
                    focusedPlayers.custom1 = dealer;
                } else if (!focusedPlayers.custom2) {
                    focusedPlayers.custom2 = dealer;
                }
            }

            renderPersonalTable();
            renderAvailablePlayers();
        }

        function isPlayerInFocus(playerId) {
            return Object.values(focusedPlayers).some(player => player && player.id === playerId);
        }

        function renderPersonalTable() {
            const focusGrid = document.getElementById('focusGrid');
            focusGrid.innerHTML = '';

            // Left neighbor
            const leftSlot = createFocusSlot('left-neighbor', focusedPlayers.leftNeighbor, false);
            focusGrid.appendChild(leftSlot);

            // Current turn (center)
            const currentSlot = createFocusSlot('current-turn', focusedPlayers.currentTurn, false);
            focusGrid.appendChild(currentSlot);

            // Right neighbor
            const rightSlot = createFocusSlot('right-neighbor', focusedPlayers.rightNeighbor, false);
            focusGrid.appendChild(rightSlot);

            // Custom slot 1
            const custom1Slot = createFocusSlot('custom', focusedPlayers.custom1, true);
            focusGrid.appendChild(custom1Slot);

            // Custom slot 2
            const custom2Slot = createFocusSlot('custom', focusedPlayers.custom2, true);
            focusGrid.appendChild(custom2Slot);
        }

        function createFocusSlot(type, player, removable) {
            const slot = document.createElement('div');
            slot.className = `focus-slot ${type}`;

            if (!player) {
                slot.classList.add('empty');
                slot.innerHTML = `
                    <div class="add-icon">+</div>
                    <div>Tap player below</div>
                `;
                return slot;
            }

            // Video container
            const videoContainer = document.createElement('div');
            videoContainer.className = 'video-container';
            videoContainer.innerHTML = `<div class="video-element" id="video-${player.id}"></div>`;

            // Player info
            const playerInfo = document.createElement('div');
            playerInfo.className = 'player-info';
            playerInfo.innerHTML = `
                <span class="player-name">${player.name}${player.isDealer ? ' (Dealer)' : ''}</span>
                <span class="player-lives">‚ù§Ô∏è ${player.lives || 3}</span>
            `;

            // Card display
            const cardDisplay = document.createElement('div');
            cardDisplay.className = 'card-display';
            
            if (player.currentCard && player.currentCard.revealed) {
                const card = player.currentCard;
                cardDisplay.className += card.suit === '‚ô•' || card.suit === '‚ô¶' ? ' red' : ' black';
                cardDisplay.textContent = `${card.value}${card.suit}`;
            } else {
                cardDisplay.className += ' face-down';
                cardDisplay.textContent = 'üÇ†';
            }

            slot.appendChild(videoContainer);
            slot.appendChild(playerInfo);
            slot.appendChild(cardDisplay);

            // Action button for right neighbor
            if (type === 'right-neighbor' && canTradeWith(player)) {
                const actionBtn = document.createElement('button');
                actionBtn.className = 'action-button';
                actionBtn.textContent = 'Trade ‚Üí';
                actionBtn.onclick = () => requestTrade(player.id);
                slot.appendChild(actionBtn);
            }

            // Remove button for custom slots
            if (removable) {
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-button';
                removeBtn.textContent = '√ó';
                removeBtn.onclick = () => removeFromFocus(player.id);
                slot.appendChild(removeBtn);
            }

            return slot;
        }

        function canTradeWith(player) {
            if (!currentGame) return false;
            const myPlayer = currentGame.players.find(p => p.id === playerId);
            const isMyTurn = currentGame.currentPlayerIndex !== undefined && 
                           currentGame.players[currentGame.currentPlayerIndex]?.id === playerId;
            return isMyTurn && player.lives > 0;
        }

        function renderAvailablePlayers() {
            const playersScroll = document.getElementById('playersScroll');
            playersScroll.innerHTML = '';

            if (!currentGame || !currentGame.players) return;

            currentGame.players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'available-player';
                
                if (isPlayerInFocus(player.id)) {
                    playerDiv.classList.add('focused');
                    const checkMark = document.createElement('div');
                    checkMark.className = 'check-mark';
                    checkMark.textContent = '‚úì';
                    playerDiv.appendChild(checkMark);
                }

                playerDiv.innerHTML += `
                    <div class="player-name">${player.name}</div>
                    <div class="mini-card ${player.currentCard && player.currentCard.revealed ? '' : 'face-down'}">
                        ${player.currentCard && player.currentCard.revealed ? 
                          `${player.currentCard.value}${player.currentCard.suit}` : 'üÇ†'}
                    </div>
                `;

                playerDiv.onclick = () => addToFocus(player);
                playersScroll.appendChild(playerDiv);
            });
        }

        function addToFocus(player) {
            if (isPlayerInFocus(player.id)) return;

            if (!focusedPlayers.custom1) {
                focusedPlayers.custom1 = player;
            } else if (!focusedPlayers.custom2) {
                focusedPlayers.custom2 = player;
            } else {
                // Replace custom1 with this player
                focusedPlayers.custom1 = player;
            }

            renderPersonalTable();
            renderAvailablePlayers();
            
            // Try to start video for this player
            setTimeout(() => {
                initializeVideoForPlayer(player.id);
            }, 100);
        }

        function removeFromFocus(playerId) {
            if (focusedPlayers.custom1 && focusedPlayers.custom1.id === playerId) {
                focusedPlayers.custom1 = null;
            } else if (focusedPlayers.custom2 && focusedPlayers.custom2.id === playerId) {
                focusedPlayers.custom2 = null;
            }

            renderPersonalTable();
            renderAvailablePlayers();
        }

        // Game actions
        function flipCard() {
            if (!socket || !currentGame) return;
            socket.emit('flip-card');
            log('üé¥ Attempting to flip your card...');
        }

        function keepCard() {
            if (!socket || !currentGame) return;
            socket.emit('skip-turn');
            log('‚úã Keeping your card...');
        }

        function requestTrade(targetPlayerId) {
            if (!socket || !currentGame) return;
            socket.emit('request-trade', { targetPlayerId });
            log(`üîÑ Requesting trade with player ${targetPlayerId}`);
        }

        function endRound() {
            if (!socket || !currentGame) return;
            socket.emit('end-round');
            log('‚è∞ Ending round...');
        }

        function leaveGame() {
            if (confirm('Are you sure you want to leave the game?')) {
                if (socket) {
                    socket.emit('leave-game');
                }
                leaveVideoCall();
                showMainMenu();
            }
        }

        // Chat functions
        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (message && socket) {
                socket.emit('chat-message', { message });
                chatInput.value = '';
            }
        }

        // Video integration
        function initializeVideoCall() {
            if (isVideoJoined) return;

            log('üìπ Initializing video call...');
            
            try {
                agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
                log('üìπ Agora client created successfully');

                agoraClient.on("user-published", handleUserPublished);
                agoraClient.on("user-unpublished", handleUserUnpublished);
                agoraClient.on("user-left", handleUserLeft);
                log('üìπ Event listeners added');

                joinVideoChannel();
            } catch (error) {
                log(`‚ùå Error initializing video: ${error.message}`);
            }
        }

        async function joinVideoChannel() {
            try {
                const channelName = currentGame?.gameCode || 'test123';
                const uid = Math.floor(Math.random() * 1000000);
                const appId = 'cfef8101dcc14802a8f97d8805b3ebc9';

                log(`üìπ Attempting to join channel: ${channelName}`);
                log(`üìπ Using UNIQUE UID: ${uid}`);
                log(`üìπ App ID: ${appId}`);

                await agoraClient.join(appId, channelName, null, uid);
                log('üìπ Successfully joined channel with token!');

                // Create local tracks
                log('üìπ Requesting camera access...');
                localVideoTrack = await AgoraRTC.createCameraVideoTrack();
                log('üìπ Camera access granted!');

                log('üìπ Requesting microphone access...');
                localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                log('üìπ Microphone access granted!');

                // Play local video
                const myVideoElement = document.getElementById(`video-${playerId}`);
                if (myVideoElement) {
                    localVideoTrack.play(myVideoElement);
                    log('üìπ Local video added to UI');
                }

                // Publish tracks
                log('üìπ Publishing video/audio tracks...');
                await agoraClient.publish([localVideoTrack, localAudioTrack]);
                log('üìπ Tracks published successfully!');

                isVideoJoined = true;
                log('üìπ Video call started successfully!');

            } catch (error) {
                log(`‚ùå Error joining video channel: ${error.message}`);
            }
        }

        async function handleUserPublished(user, mediaType) {
            log(`üîä ${user.uid} started ${mediaType}`);
            
            await agoraClient.subscribe(user, mediaType);
            
            if (mediaType === 'video') {
                const videoElement = document.getElementById(`video-${user.uid}`);
                if (videoElement) {
                    user.videoTrack.play(videoElement);
                    log(`üìπ Playing video for user ${user.uid}`);
                }
            }
            
            remoteUsers[user.uid] = user;
        }

        function handleUserUnpublished(user, mediaType) {
            log(`üîá ${user.uid} stopped ${mediaType}`);
            
            if (mediaType === 'video') {
                const videoElement = document.getElementById(`video-${user.uid}`);
                if (videoElement) {
                    videoElement.innerHTML = '';
                }
            }
        }

        function handleUserLeft(user) {
            log(`üëã ${user.uid} left video call`);
            delete remoteUsers[user.uid];
        }

        function initializeVideoForPlayer(playerId) {
            const remoteUser = remoteUsers[playerId];
            if (remoteUser && remoteUser.videoTrack) {
                const videoElement = document.getElementById(`video-${playerId}`);
                if (videoElement) {
                    remoteUser.videoTrack.play(videoElement);
                    log(`üìπ Initialized video for player ${playerId}`);
                }
            }
        }

        async function leaveVideoCall() {
            if (!isVideoJoined) return;

            try {
                log('üìπ Leaving video call...');
                
                if (localVideoTrack) {
                    localVideoTrack.stop();
                    localVideoTrack.close();
                }
                
                if (localAudioTrack) {
                    localAudioTrack.stop();
                    localAudioTrack.close();
                }
                
                if (agoraClient) {
                    await agoraClient.leave();
                }
                
                isVideoJoined = false;
                remoteUsers = {};
                log('üìπ Left video call');
                
            } catch (error) {
                log(`‚ùå Error leaving video call: ${error.message}`);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üéÆ Game loaded with Personal Table integration!');
            
            // Set up chat input handler
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
        });
    </script>
</body>
</html>