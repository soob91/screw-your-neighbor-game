<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screw Your Neighbor - Personal Table</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Personal Table Focus Area */
        .personal-table {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .table-title {
            text-align: center;
            font-size: 14px;
            margin-bottom: 15px;
            color: #FFD700;
            font-weight: bold;
        }
        
        /* Focus Grid - 5 slots */
        .focus-grid {
            display: grid;
            grid-template-columns: 1fr 0.8fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        /* Left neighbor - slot 1 */
        .slot-left {
            grid-column: 1;
            grid-row: 1;
        }
        
        /* Current player - slot 2 (center, smaller) */
        .slot-center {
            grid-column: 2;
            grid-row: 1;
        }
        
        /* Right neighbor - slot 3 */
        .slot-right {
            grid-column: 3;
            grid-row: 1;
        }
        
        /* Custom slots - bottom row */
        .slot-custom1 {
            grid-column: 1;
            grid-row: 2;
        }
        
        .slot-custom2 {
            grid-column: 3;
            grid-row: 2;
        }
        
        /* Player Focus Card */
        .focus-card {
            background: rgba(0,0,0,0.6);
            border-radius: 12px;
            padding: 10px;
            border: 3px solid transparent;
            min-height: 130px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .focus-card:hover {
            transform: scale(1.02);
            background: rgba(0,0,0,0.7);
        }
        
        .focus-card.current-turn {
            border-color: #00FF00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.4);
        }
        
        .focus-card.dealer {
            border-color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        
        .focus-card.my-neighbor {
            border-color: #FF6B35;
        }
        
        .focus-card.empty {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .focus-card.small {
            min-height: 100px;
        }
        
        /* Video in Focus Card */
        .focus-video {
            width: 100%;
            height: 60px;
            background: #333;
            border-radius: 6px;
            margin-bottom: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .focus-video.small {
            height: 45px;
        }
        
        .focus-video video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .focus-video.no-video {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #333, #555);
            color: #999;
            font-size: 11px;
        }
        
        /* Player Info in Focus Card */
        .focus-name {
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
            line-height: 1.2;
        }
        
        .focus-status {
            font-size: 10px;
            text-align: center;
            opacity: 0.8;
            margin-bottom: 6px;
        }
        
        /* Game Card in Focus Card */
        .focus-game-card {
            width: 35px;
            height: 45px;
            background: #fff;
            color: #000;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 6px;
            font-weight: bold;
            font-size: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .focus-game-card:hover {
            transform: scale(1.1);
        }
        
        .focus-game-card.face-down {
            background: linear-gradient(45deg, #8B0000, #A0522D);
            color: white;
        }
        
        .focus-game-card.face-down:before {
            content: "🂠";
            font-size: 12px;
            color: #FFD700;
        }
        
        .focus-game-card.revealed {
            background: #fff;
            color: #000;
        }
        
        .focus-game-card.red {
            color: #ff0000;
        }
        
        /* Lives indicator */
        .focus-lives {
            display: flex;
            justify-content: center;
            gap: 2px;
            margin-bottom: 4px;
        }
        
        .focus-life {
            width: 6px;
            height: 6px;
            background: #ff4444;
            border-radius: 50%;
        }
        
        /* Empty slot styling */
        .empty-slot {
            color: rgba(255, 255, 255, 0.5);
            font-size: 24px;
            text-align: center;
        }
        
        /* Remove button */
        .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(244, 67, 54, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }
        
        .focus-card:hover .remove-btn {
            display: block;
        }
        
        /* Action buttons in focus cards */
        .focus-actions {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-top: 4px;
        }
        
        .action-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 9px;
            cursor: pointer;
        }
        
        .action-btn.trade {
            background: #FF6B35;
        }
        
        .action-btn.keep {
            background: #FFA726;
        }
        
        /* Available Players Bar */
        .available-players {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 12px;
            margin: 15px 0;
        }
        
        .available-title {
            font-size: 12px;
            margin-bottom: 8px;
            text-align: center;
            opacity: 0.9;
        }
        
        .players-scroll {
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .players-list {
            display: flex;
            gap: 8px;
            min-width: max-content;
            padding: 5px 0;
        }
        
        /* Available Player Cards */
        .available-player {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px;
            min-width: 65px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .available-player:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #FFD700;
            transform: translateY(-2px);
        }
        
        .available-player.in-focus {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }
        
        .available-player.eliminated {
            opacity: 0.5;
            background: rgba(244, 67, 54, 0.2);
            border-color: #f44336;
        }
        
        .available-name {
            font-size: 10px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .available-card {
            width: 30px;
            height: 38px;
            background: #fff;
            color: #000;
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 4px;
            font-size: 8px;
            font-weight: bold;
        }
        
        .available-card.face-down {
            background: linear-gradient(45deg, #8B0000, #A0522D);
            color: white;
        }
        
        .available-card.face-down:before {
            content: "🂠";
            font-size: 10px;
            color: #FFD700;
        }
        
        .available-card.red {
            color: #ff0000;
        }
        
        .available-lives {
            display: flex;
            justify-content: center;
            gap: 2px;
        }
        
        .available-life {
            width: 4px;
            height: 4px;
            background: #ff4444;
            border-radius: 50%;
        }
        
        /* Game Status */
        .game-status {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #FFD700;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            font-size: 13px;
            margin-bottom: 15px;
        }
        
        /* Quick Controls */
        .quick-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
        }
        
        .control-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .control-btn.danger {
            background: #f44336;
        }
        
        .control-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        /* Video Controls */
        .video-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .video-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .video-btn.active {
            background: #45a049;
        }
        
        .video-btn.inactive {
            background: #f44336;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }
        
        .connected {
            background: #4CAF50;
        }
        
        .disconnected {
            background: #f44336;
        }
        
        /* Main Menu (hidden during game) */
        .main-menu {
            background: rgba(0,0,0,0.4);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .menu-section {
            margin: 25px 0;
        }
        
        .quick-match-btn {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            margin: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
            transition: transform 0.2s;
            border: none;
            color: white;
            cursor: pointer;
        }
        
        .private-game-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            margin: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: transform 0.2s;
            border: none;
            color: white;
            cursor: pointer;
        }
        
        input {
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            color: black;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">Disconnected</div>
    
    <!-- Main Menu (shown before joining game) -->
    <div class="main-menu" id="main-menu">
        <h1>🎮 Screw Your Neighbor</h1>
        <div class="menu-section">
            <h3>Join a Game</h3>
            <input type="text" id="player-name" placeholder="Enter your name" maxlength="20">
            
            <button onclick="quickMatch()" class="quick-match-btn">
                ⚡ Quick Match
                <small style="display: block; font-size: 12px; opacity: 0.9; margin-top: 5px;">Join any available game instantly</small>
            </button>
            
            <div style="margin: 20px 0; color: #ccc; font-style: italic;">or</div>
            
            <button onclick="showPrivateOptions()" class="private-game-btn">
                👥 Play with Friends
                <small style="display: block; font-size: 12px; opacity: 0.9; margin-top: 5px;">Create or join a private game</small>
            </button>
        </div>
    </div>
    
    <!-- Game Content (Personal Table Layout) -->
    <div id="gameContent" class="hidden">
        
        <!-- Game Status -->
        <div class="game-status" id="gameStatus">
            🎯 Connecting to game...
        </div>
        
        <!-- Video Controls -->
        <div class="video-controls" id="videoControls">
            <button class="video-btn" id="joinVideoBtn" onclick="joinVideoCall()">📹 Join Video</button>
            <button class="video-btn hidden" id="leaveVideoBtn" onclick="leaveVideoCall()">📹 Leave</button>
            <button class="video-btn hidden" id="muteBtn" onclick="toggleMute()">🔇 Mute</button>
            <button class="video-btn hidden" id="videoToggleBtn" onclick="toggleVideo()">📷 Off</button>
        </div>
        
        <!-- Personal Table Focus Area -->
        <div class="personal-table">
            <div class="table-title">🪑 Your Personal Table View</div>
            
            <div class="focus-grid" id="focusGrid">
                <!-- Focus slots will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Available Players -->
        <div class="available-players" id="availablePlayersSection">
            <div class="available-title">👥 Tap any player to add them to your table</div>
            <div class="players-scroll">
                <div class="players-list" id="availablePlayersList">
                    <!-- Available players will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Quick Controls -->
        <div class="quick-controls">
            <button class="control-btn" onclick="flipMyCard()" id="flipCardBtn">🎴 Flip Card</button>
            <button class="control-btn" onclick="keepCard()" id="keepCardBtn">⭐ Keep Card</button>
            <button class="control-btn" onclick="endRound()" id="endRoundBtn">🏁 End Round</button>
            <button class="control-btn danger" onclick="leaveGame()">🚪 Leave</button>
        </div>
        
    </div>

    <!-- Scripts -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.19.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script>
        // =====================================================================
        // 🔑 REPLACE THIS WITH YOUR AGORA APP ID
        // =====================================================================
        const AGORA_APP_ID = "cfef8101dcc14802a8f97d8805b3ebc9";
        
        // Game variables
        let socket = null;
        let currentGame = null;
        let myPlayerId = null;
        let isConnected = false;
        let myFriendCode = null;

        // Agora video variables
        let agoraClient = null;
        let localTracks = {
            videoTrack: null,
            audioTrack: null
        };
        let remoteUsers = {};
        let isVideoJoined = false;
        let isMuted = false;
        let isVideoOff = false;

        // Personal Table State
        let focusedPlayers = {
            left: null,     // Left neighbor
            center: null,   // Current turn player
            right: null,    // Right neighbor
            custom1: null,  // Custom slot 1
            custom2: null   // Custom slot 2
        };

        // =====================================================================
        // CONNECTION AND GAME MANAGEMENT
        // =====================================================================

        function connectToServer() {
            if (socket) {
                socket.disconnect();
            }

            console.log('🔄 Connecting to server...');
            
            socket = io({
                timeout: 60000,
                pingTimeout: 120000,
                pingInterval: 30000,
                reconnection: true,
                reconnectionAttempts: 10,
                reconnectionDelay: 2000,
                reconnectionDelayMax: 10000,
                transports: ['websocket', 'polling'],
                upgrade: true,
                rememberUpgrade: true,
                forceNew: true,
                autoConnect: true
            });
            
            if (!myPlayerId) {
                myPlayerId = 'player_' + Math.random().toString(36).substr(2, 9);
            }

            socket.on('connect', function() {
                console.log('✅ Connected to server!');
                updateConnectionStatus(true);
                
                const playerName = document.getElementById('player-name').value || 'Player1';
                socket.emit('get-friend-code', { 
                    userId: myPlayerId, 
                    userName: playerName 
                });
            });

            socket.on('disconnect', function(reason) {
                console.log('❌ Disconnected:', reason);
                updateConnectionStatus(false);
            });

            socket.on('error', function(data) {
                console.log('❌ Error:', data.message);
                alert('Error: ' + data.message);
            });

            // Game event handlers
            socket.on('game-created', function(data) {
                console.log('🎮 Game created!');
                currentGame = data.game;
                showGameContent();
                updatePersonalTable();
            });

            socket.on('game-joined', function(data) {
                console.log('🎮 Game joined!');
                currentGame = data.game;
                showGameContent();
                updatePersonalTable();
            });

            socket.on('player-joined', function(data) {
                console.log('👋 Player joined:', data.newPlayer?.name);
                currentGame = data.game;
                updatePersonalTable();
            });

            socket.on('game-started', function(data) {
                console.log('🎮 Game started!');
                currentGame = data.game;
                updatePersonalTable();
            });

            socket.on('trade-completed', function(data) {
                console.log('🔄 Trade completed');
                currentGame = data.game;
                updatePersonalTable();
            });

            socket.on('turn-skipped', function(data) {
                console.log('⏭️ Turn skipped');
                currentGame = data.game;
                updatePersonalTable();
            });

            socket.on('card-flipped', function(data) {
                console.log('🎴 Card flipped');
                currentGame = data.game;
                updatePersonalTable();
            });

            socket.on('round-ended', function(data) {
                console.log('🏁 Round ended');
                currentGame = data.game;
                updatePersonalTable();
            });

            socket.on('dealer-traded-deck', function(data) {
                console.log('🎴 Dealer traded with deck');
                currentGame = data.game;
                updatePersonalTable();
            });

            socket.on('dealer-skipped-trade', function(data) {
                console.log('⏭️ Dealer skipped trade');
                currentGame = data.game;
                updatePersonalTable();
            });
        }

        function updateConnectionStatus(connected) {
            isConnected = connected;
            const status = document.getElementById('connectionStatus');
            status.textContent = connected ? 'Connected' : 'Disconnected';
            status.className = 'connection-status ' + (connected ? 'connected' : 'disconnected');
        }

        // =====================================================================
        // GAME JOINING FUNCTIONS
        // =====================================================================

        function quickMatch() {
            const playerName = document.getElementById('player-name').value.trim();
            if (!playerName) {
                alert('Please enter your name first!');
                return;
            }
            
            if (!myPlayerId) {
                myPlayerId = 'player_' + Math.random().toString(36).substr(2, 9);
            }
            
            if (!socket) {
                connectToServer();
            }
            
            // Show loading state
            document.getElementById('main-menu').innerHTML = `
                <div style="text-align: center;">
                    <h2>🔍 Finding a game...</h2>
                    <p>Looking for available players...</p>
                    <div style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto;"></div>
                    <button onclick="location.reload()">Cancel</button>
                </div>
                <style>
                @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                </style>
            `;
            
            socket.emit('quick-match', { 
                userId: myPlayerId,
                token: 'demo_token_' + myPlayerId,
                playerName: playerName 
            });
        }

        function showPrivateOptions() {
            alert('Private games coming soon! Use Quick Match for now.');
        }

        function showGameContent() {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('gameContent').classList.remove('hidden');
        }

        // =====================================================================
        // PERSONAL TABLE MANAGEMENT
        // =====================================================================

        function updatePersonalTable() {
            if (!currentGame || !currentGame.players) {
                updateGameStatus('🎮 Waiting for game data...');
                return;
            }

            console.log('🔄 Updating personal table with game data');
            
            // Update game status
            updateGameStatus();
            
            // Calculate focus assignments
            calculateFocusAssignments();
            
            // Update focus grid
            updateFocusGrid();
            
            // Update available players
            updateAvailablePlayersList();
            
            // Update control buttons
            updateControlButtons();
        }

        function calculateFocusAssignments() {
            const activePlayers = currentGame.players.filter(p => p.lives > 0);
            if (activePlayers.length === 0) return;

            const myIndex = activePlayers.findIndex(p => p.id === myPlayerId);
            if (myIndex === -1) return; // I'm a spectator or eliminated

            // Calculate neighbors
            const leftIndex = (myIndex - 1 + activePlayers.length) % activePlayers.length;
            const rightIndex = (myIndex + 1) % activePlayers.length;
            
            // Assign core positions
            focusedPlayers.left = activePlayers[leftIndex]?.id || null;
            focusedPlayers.right = activePlayers[rightIndex]?.id || null;
            focusedPlayers.center = currentGame.currentPlayerId;

            // Keep custom slots if players are still active, otherwise clear them
            if (focusedPlayers.custom1) {
                const player = currentGame.players.find(p => p.id === focusedPlayers.custom1);
                if (!player || player.lives <= 0) {
                    focusedPlayers.custom1 = null;
                }
            }
            if (focusedPlayers.custom2) {
                const player = currentGame.players.find(p => p.id === focusedPlayers.custom2);
                if (!player || player.lives <= 0) {
                    focusedPlayers.custom2 = null;
                }
            }

            // Auto-fill custom slots with dealer and other interesting players
            if (!focusedPlayers.custom1 && currentGame.dealerId && 
                currentGame.dealerId !== focusedPlayers.left && 
                currentGame.dealerId !== focusedPlayers.right && 
                currentGame.dealerId !== focusedPlayers.center) {
                focusedPlayers.custom1 = currentGame.dealerId;
            }
        }

        function updateFocusGrid() {
            const focusGrid = document.getElementById('focusGrid');
            focusGrid.innerHTML = '';

            // Create focus slots
            const slots = [
                { key: 'left', class: 'slot-left my-neighbor', label: '← Left' },
                { key: 'center', class: 'slot-center small current-turn', label: '🎯 Turn' },
                { key: 'right', class: 'slot-right my-neighbor', label: 'Right →' },
                { key: 'custom1', class: 'slot-custom1', label: 'Custom' },
                { key: 'custom2', class: 'slot-custom2', label: 'Custom' }
            ];

            slots.forEach(slot => {
                const playerId = focusedPlayers[slot.key];
                const player = playerId ? currentGame.players.find(p => p.id === playerId) : null;
                
                const slotDiv = document.createElement('div');
                slotDiv.className = `focus-card ${slot.class}`;
                slotDiv.id = `${slot.key}Slot`;

                if (player) {
                    // Player in slot
                    slotDiv.innerHTML = createFocusPlayerHTML(player, slot);
                    if (slot.key.startsWith('custom')) {
                        slotDiv.onclick = () => removeFromFocus(slot.key);
                    }
                } else {
                    // Empty slot
                    slotDiv.classList.add('empty');
                    slotDiv.innerHTML = `
                        <div class="empty-slot">
                            <div>+</div>
                            <div style="font-size: 10px;">Tap player below</div>
                        </div>
                    `;
                    slotDiv.onclick = () => showAvailablePlayers();
                }

                focusGrid.appendChild(slotDiv);
            });
        }

        function createFocusPlayerHTML(player, slot) {
            const isMe = player.id === myPlayerId;
            const isCurrentTurn = player.id === currentGame.currentPlayerId;
            const isDealer = player.id === currentGame.dealerId;
            
            // Player name with indicators
            let playerName = player.name;
            if (isMe) playerName = `📹 ${playerName} (You)`;
            else if (isCurrentTurn) playerName = `🎯 ${playerName}`;
            else if (isDealer) playerName = `💰 ${playerName}`;
            
            if (slot.key === 'left') playerName = `← ${playerName}`;
            if (slot.key === 'right') playerName = `${playerName} →`;

            // Video element
            const videoHTML = `
                <div class="focus-video ${slot.class.includes('small') ? 'small' : ''}" id="${slot.key}Video">
                    ${isVideoJoined ? '<video autoplay muted></video>' : '<div class="no-video">📹 Join Video</div>'}
                </div>
            `;

            // Lives display
            const livesHTML = Array(player.lives).fill('<div class="focus-life"></div>').join('');

            // Card display
            const cardHTML = createCardHTML(player, 'focus-game-card');

            // Status text
            let statusText = `${player.lives} lives`;
            if (isDealer) statusText += ' • Dealer';
            if (isCurrentTurn) statusText += ' • Your turn';
            if (player.hasTraded) statusText += ' • Traded';

            // Action buttons
            let actionsHTML = '';
            if (canTradeWithPlayer(player.id)) {
                actionsHTML = `
                    <div class="focus-actions">
                        <button class="action-btn trade" onclick="tradeWithPlayer('${player.id}')">Trade →</button>
                    </div>
                `;
            }

            // Remove button for custom slots
            let removeBtn = '';
            if (slot.key.startsWith('custom')) {
                removeBtn = '<button class="remove-btn" onclick="removeFromFocus(\'' + slot.key + '\')">×</button>';
            }

            return `
                ${removeBtn}
                <div class="focus-name">${playerName}</div>
                ${videoHTML}
                <div class="focus-status">${statusText}</div>
                <div class="focus-lives">${livesHTML}</div>
                ${cardHTML}
                ${actionsHTML}
            `;
        }

        function updateAvailablePlayersList() {
            const playersList = document.getElementById('availablePlayersList');
            playersList.innerHTML = '';

            if (!currentGame || !currentGame.players) return;

            currentGame.players.forEach(player => {
                const isInFocus = Object.values(focusedPlayers).includes(player.id);
                const isEliminated = player.lives <= 0;
                
                const playerDiv = document.createElement('div');
                playerDiv.className = `available-player ${isInFocus ? 'in-focus' : ''} ${isEliminated ? 'eliminated' : ''}`;
                playerDiv.setAttribute('data-player', player.id);
                playerDiv.onclick = () => addToFocus(player.id);

                const livesHTML = Array(player.lives).fill('<div class="available-life"></div>').join('');
                const cardHTML = createCardHTML(player, 'available-card');

                playerDiv.innerHTML = `
                    <div class="available-name">${player.name}${isInFocus ? ' ✓' : ''}</div>
                    ${cardHTML}
                    <div class="available-lives">${livesHTML}</div>
                `;

                playersList.appendChild(playerDiv);
            });
        }

        function createCardHTML(player, className) {
            if (!player.card || !player.cardRevealed) {
                return `<div class="${className} face-down"></div>`;
            }

            const isRed = player.card.suit === '♥' || player.card.suit === '♦';
            return `
                <div class="${className} revealed ${isRed ? 'red' : ''}">
                    <div>${player.card.value}</div>
                    <div>${player.card.suit}</div>
                </div>
            `;
        }

        function addToFocus(playerId) {
            console.log('🎮 Adding player to focus:', playerId);
            
            // Find empty custom slot
            let targetSlot = null;
            if (!focusedPlayers.custom1) {
                targetSlot = 'custom1';
            } else if (!focusedPlayers.custom2) {
                targetSlot = 'custom2';
            } else {
                // Replace custom2
                targetSlot = 'custom2';
            }
            
            // Remove from previous slot if already focused
            Object.keys(focusedPlayers).forEach(slot => {
                if (focusedPlayers[slot] === playerId) {
                    focusedPlayers[slot] = null;
                }
            });
            
            // Add to new slot
            focusedPlayers[targetSlot] = playerId;
            
            updatePersonalTable();
            
            // Add video for this player if video is active
            if (isVideoJoined) {
                createVideoForPlayer(playerId, targetSlot);
            }
        }

        function removeFromFocus(slot) {
            console.log('🎮 Removing from focus slot:', slot);
            
            if (slot.startsWith('custom')) {
                focusedPlayers[slot] = null;
                updatePersonalTable();
            }
        }

        function showAvailablePlayers() {
            document.getElementById('availablePlayersSection').scrollIntoView({ behavior: 'smooth' });
        }

        // =====================================================================
        // GAME STATUS AND CONTROLS
        // =====================================================================

        function updateGameStatus() {
            if (!currentGame) {
                document.getElementById('gameStatus').textContent = '🎮 Connecting to game...';
                return;
            }

            const isMyTurn = currentGame.currentPlayerId === myPlayerId;
            const currentPlayer = currentGame.players.find(p => p.id === currentGame.currentPlayerId);
            const phase = currentGame.turnPhase || 'trading';
            
            let statusText = '';
            
            if (isMyTurn) {
                if (phase === 'trading') {
                    statusText = '🎯 Your turn! Trade with next player or keep your card.';
                } else if (phase === 'dealer-turn') {
                    statusText = '🎯 Your dealer turn! Trade with deck or skip.';
                } else {
                    statusText = '🎯 Your turn!';
                }
            } else if (currentPlayer) {
                statusText = `⏳ ${currentPlayer.name}'s turn...`;
            } else {
                statusText = `Round ${currentGame.round || 1} | ${currentGame.players?.length || 0} players`;
            }

            document.getElementById('gameStatus').textContent = statusText;
        }

        function updateControlButtons() {
            const isMyTurn = currentGame?.currentPlayerId === myPlayerId;
            const phase = currentGame?.turnPhase || 'trading';
            
            document.getElementById('flipCardBtn').disabled = false;
            document.getElementById('keepCardBtn').disabled = !isMyTurn || phase !== 'trading';
            document.getElementById('endRoundBtn').disabled = phase !== 'revealing';
        }

        function canTradeWithPlayer(playerId) {
            if (!currentGame || currentGame.currentPlayerId !== myPlayerId) return false;
            if (currentGame.turnPhase !== 'trading') return false;
            
            // Check if this is the next player in sequence
            const activePlayers = currentGame.players.filter(p => p.lives > 0);
            const myIndex = activePlayers.findIndex(p => p.id === myPlayerId);
            const nextIndex = (myIndex + 1) % activePlayers.length;
            const nextPlayer = activePlayers[nextIndex];
            
            return nextPlayer?.id === playerId;
        }

        // =====================================================================
        // GAME ACTIONS
        // =====================================================================

        function tradeWithPlayer(playerId) {
            if (!currentGame) return;
            
            console.log('🔄 Trading with player:', playerId);
            
            socket.emit('trade-request', {
                gameId: currentGame.id,
                targetPlayerId: playerId,
                direction: 'right'
            });
        }

        function keepCard() {
            if (!currentGame) return;
            
            console.log('⭐ Keeping card');
            
            socket.emit('skip-turn', {
                gameId: currentGame.id
            });
        }

        function flipMyCard() {
            if (!currentGame) return;
            
            console.log('🎴 Flipping my card');
            
            socket.emit('flip-card', {
                gameId: currentGame.id
            });
        }

        function endRound() {
            if (!currentGame) return;
            
            console.log('🏁 Ending round');
            
            socket.emit('end-round', {
                gameId: currentGame.id
            });
        }

        async function leaveGame() {
            if (!currentGame) return;
            
            if (confirm('Are you sure you want to leave the game?')) {
                await leaveVideoCall();
                socket.disconnect();
                location.reload();
            }
        }

        // =====================================================================
        // VIDEO INTEGRATION
        // =====================================================================

        async function joinVideoCall() {
            if (!currentGame) {
                alert('Please join a game first!');
                return;
            }

            try {
                console.log('📹 Joining video call...');
                
                agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
                
                agoraClient.on("user-published", handleUserPublished);
                agoraClient.on("user-unpublished", handleUserUnpublished);
                agoraClient.on("user-left", handleUserLeft);
                
                const channel = "test123";
                const uid = Math.floor(Math.random() * 1000000) + Date.now() % 1000000;
                const tempToken = "007eJxTYNgYbd/46v6M/rOFAu/PrPIve1R+47dYpNDNCffPbQ1m61uowJCclppmYWhgmJKcbGhiYWCUaJFmaZ5iYWFgmmScmpRsWWgfn9EQyMigvjyEhZEBAkF8doaS1OISQyNjBgYAkUYiRg==";
                
                await agoraClient.join(AGORA_APP_ID, channel, tempToken, uid);
                
                localTracks.videoTrack = await AgoraRTC.createCameraVideoTrack();
                localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                
                await agoraClient.publish([localTracks.audioTrack, localTracks.videoTrack]);
                
                isVideoJoined = true;
                updateVideoButtons();
                updatePersonalTable(); // Refresh to show video elements
                
                console.log('📹 Video call joined successfully!');
                
            } catch (error) {
                console.error('Video call error:', error);
                alert('Failed to join video call: ' + error.message);
            }
        }

        async function leaveVideoCall() {
            if (!isVideoJoined) return;

            try {
                if (localTracks.audioTrack) {
                    localTracks.audioTrack.stop();
                    localTracks.audioTrack.close();
                    localTracks.audioTrack = null;
                }
                if (localTracks.videoTrack) {
                    localTracks.videoTrack.stop();
                    localTracks.videoTrack.close();
                    localTracks.videoTrack = null;
                }

                Object.keys(remoteUsers).forEach(uid => {
                    delete remoteUsers[uid];
                });

                if (agoraClient) {
                    await agoraClient.leave();
                    agoraClient = null;
                }

                isVideoJoined = false;
                updateVideoButtons();
                updatePersonalTable(); // Refresh to hide video elements
                
                console.log('📹 Left video call');

            } catch (error) {
                console.error('Error leaving video call:', error);
            }
        }

        async function toggleMute() {
            if (!localTracks.audioTrack) return;

            try {
                if (isMuted) {
                    await localTracks.audioTrack.setEnabled(true);
                    isMuted = false;
                } else {
                    await localTracks.audioTrack.setEnabled(false);
                    isMuted = true;
                }
                updateVideoButtons();
            } catch (error) {
                console.error('Error toggling mute:', error);
            }
        }

        async function toggleVideo() {
            if (!localTracks.videoTrack) return;

            try {
                if (isVideoOff) {
                    await localTracks.videoTrack.setEnabled(true);
                    isVideoOff = false;
                } else {
                    await localTracks.videoTrack.setEnabled(false);
                    isVideoOff = true;
                }
                updateVideoButtons();
            } catch (error) {
                console.error('Error toggling video:', error);
            }
        }

        function updateVideoButtons() {
            const joinBtn = document.getElementById('joinVideoBtn');
            const leaveBtn = document.getElementById('leaveVideoBtn');
            const muteBtn = document.getElementById('muteBtn');
            const videoBtn = document.getElementById('videoToggleBtn');

            if (isVideoJoined) {
                joinBtn.classList.add('hidden');
                leaveBtn.classList.remove('hidden');
                muteBtn.classList.remove('hidden');
                videoBtn.classList.remove('hidden');

                muteBtn.textContent = isMuted ? '🔇 Unmute' : '🔇 Mute';
                muteBtn.className = isMuted ? 'video-btn inactive' : 'video-btn active';

                videoBtn.textContent = isVideoOff ? '📷 On' : '📷 Off';
                videoBtn.className = isVideoOff ? 'video-btn inactive' : 'video-btn active';
            } else {
                joinBtn.classList.remove('hidden');
                leaveBtn.classList.add('hidden');
                muteBtn.classList.add('hidden');
                videoBtn.classList.add('hidden');
            }
        }

        function createVideoForPlayer(playerId, slot) {
            console.log(`📹 Creating video element for ${playerId} in slot ${slot}`);
            
            const videoContainer = document.getElementById(`${slot}Video`);
            if (videoContainer) {
                const existingVideo = videoContainer.querySelector('video');
                if (existingVideo) {
                    existingVideo.remove();
                }
                
                const video = document.createElement('video');
                video.autoplay = true;
                video.muted = true;
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.objectFit = 'cover';
                
                videoContainer.appendChild(video);
                
                // Connect to actual video stream based on playerId
                // This would map playerId to video UID
                console.log(`📹 Video element created for ${playerId}`);
            }
        }

        // Agora event handlers
        async function handleUserPublished(user, mediaType) {
            const uid = user.uid;
            
            try {
                await agoraClient.subscribe(user, mediaType);
                
                if (!remoteUsers[uid]) {
                    remoteUsers[uid] = user;
                }

                if (mediaType === 'video') {
                    // Find the player slot for this video and play it
                    console.log(`📹 ${uid} published video`);
                    // TODO: Map UID to playerId and play in correct slot
                }
                if (mediaType === 'audio') {
                    user.audioTrack.play();
                    console.log(`🔊 ${uid} published audio`);
                }
            } catch (error) {
                console.error('Error handling user published:', error);
            }
        }

        function handleUserUnpublished(user, mediaType) {
            console.log(`📹 ${user.uid} unpublished ${mediaType}`);
        }

        function handleUserLeft(user) {
            const uid = user.uid;
            delete remoteUsers[uid];
            console.log(`👋 ${uid} left video call`);
        }

        // =====================================================================
        // INITIALIZATION
        // =====================================================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎮 Personal Table Layout loaded!');
            updateVideoButtons();
            updateConnectionStatus(false);
        });
    </script>
</body>
</html>